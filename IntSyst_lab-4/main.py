from typing import Dict, Optional
from models import Color
from solver import CSP


def create_ukraine_map() -> CSP:
    csp = CSP()
    
    regions = [
        "–ö–∏—ó–≤", "–ö–∏—ó–≤—Å—å–∫–∞", "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞",
        "–ß–µ—Ä–∫–∞—Å—å–∫–∞", "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "–°—É–º—Å—å–∫–∞", "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞",
        "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "–û–¥–µ—Å—å–∫–∞", "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞",
        "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "–õ—å–≤—ñ–≤—Å—å–∫–∞", "–í–æ–ª–∏–Ω—Å—å–∫–∞", "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞",
        "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞", "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞", "–õ—É–≥–∞–Ω—Å—å–∫–∞", "–î–æ–Ω–µ—Ü—å–∫–∞",
        "–ö—Ä–∏–º"  # –ö—Ä–∏–º - –£–∫—Ä–∞—ó–Ω–∞ 
    ]
    
    colors = [Color.RED, Color.BLUE, Color.GREEN, Color.YELLOW]
    
    for region in regions:
        csp.add_variable(region, colors)
    
    
    adjacency = [
        ("–ö–∏—ó–≤", "–ö–∏—ó–≤—Å—å–∫–∞"),
        ("–ö–∏—ó–≤—Å—å–∫–∞", "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞"),
        ("–ö–∏—ó–≤—Å—å–∫–∞", "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞"),
        ("–ö–∏—ó–≤—Å—å–∫–∞", "–ß–µ—Ä–∫–∞—Å—å–∫–∞"),
        ("–ö–∏—ó–≤—Å—å–∫–∞", "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞"),
        ("–ö–∏—ó–≤—Å—å–∫–∞", "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞"),
        ("–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞", "–°—É–º—Å—å–∫–∞"),
        ("–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞"),
        ("–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞"),
        ("–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞", "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞"),
        ("–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞"),
        ("–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "–ß–µ—Ä–∫–∞—Å—å–∫–∞"),
        ("–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞"),
        ("–í—ñ–Ω–Ω–∏—Ü—å–∫–∞", "–û–¥–µ—Å—å–∫–∞"),
        ("–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞"),
        ("–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞", "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞"),
        ("–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "–õ—å–≤—ñ–≤—Å—å–∫–∞"),
        ("–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞", "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞"),
        ("–õ—å–≤—ñ–≤—Å—å–∫–∞", "–í–æ–ª–∏–Ω—Å—å–∫–∞"),
        ("–õ—å–≤—ñ–≤—Å—å–∫–∞", "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞"),
        ("–õ—å–≤—ñ–≤—Å—å–∫–∞", "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞"),
        ("–õ—å–≤—ñ–≤—Å—å–∫–∞", "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞"),
        ("–í–æ–ª–∏–Ω—Å—å–∫–∞", "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞"),
        ("–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞", "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞"),
        ("–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞"),
        ("–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞", "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞"),        
        ("–ß–µ—Ä–∫–∞—Å—å–∫–∞", "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞"),
        ("–ß–µ—Ä–∫–∞—Å—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞"),
        ("–ß–µ—Ä–∫–∞—Å—å–∫–∞", "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞"),
        ("–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "–°—É–º—Å—å–∫–∞"),
        ("–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞"),
        ("–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞", "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞"),        
        ("–°—É–º—Å—å–∫–∞", "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞"),
        ("–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "–õ—É–≥–∞–Ω—Å—å–∫–∞"),
        ("–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "–î–æ–Ω–µ—Ü—å–∫–∞"),
        ("–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞", "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞"),
        ("–õ—É–≥–∞–Ω—Å—å–∫–∞", "–î–æ–Ω–µ—Ü—å–∫–∞"),        
        ("–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞", "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞"),
        ("–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞", "–î–æ–Ω–µ—Ü—å–∫–∞"),
        ("–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞"),
        ("–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞"),
        ("–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞", "–î–æ–Ω–µ—Ü—å–∫–∞"),
        ("–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞"),
        ("–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "–û–¥–µ—Å—å–∫–∞"),
        ("–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞"),
        ("–û–¥–µ—Å—å–∫–∞", "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞"),
        ("–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞", "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞"),        
        ("–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞", "–ö—Ä–∏–º"),
    ]
    
    for region1, region2 in adjacency:
        csp.add_constraint(region1, region2)
    
    return csp


def print_solution(solution: Optional[Dict[str, Color]]):
    if solution is None:
        print("\n‚ùå –†–æ–∑–≤'—è–∑–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")
        return
    
    print("\n‚úÖ –†–æ–∑–≤'—è–∑–æ–∫ –∑–Ω–∞–π–¥–µ–Ω–æ!")
    print("=" * 70)
    print("üó∫Ô∏è  –†–û–ó–§–ê–†–ë–£–í–ê–ù–ù–Ø –ö–ê–†–¢–ò –£–ö–†–ê–á–ù–ò")
    print("=" * 70)
    
    # –ì—Ä—É–ø—É—î–º–æ –ø–æ –∫–æ–ª—å–æ—Ä–∞–º
    by_color = {}
    for region, color in sorted(solution.items()):
        if color not in by_color:
            by_color[color] = []
        by_color[color].append(region)
    
    # –í–∏–≤–æ–¥–∏–º–æ –ø–æ –∫–æ–ª—å–æ—Ä–∞–º
    for color, regions in sorted(by_color.items(), key=lambda x: x[0].value):
        print(f"\n{color.value}:")
        for region in sorted(regions):
            print(f"  ‚Ä¢ {region}")
    
    print("\n" + "=" * 70)


def print_statistics(solution: Dict[str, Color]):
    print("\nüìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–û–ó–í'–Ø–ó–ö–£")
    print("=" * 70)
    
    color_usage = {}
    for color in solution.values():
        color_usage[color] = color_usage.get(color, 0) + 1
    
    print("\nüé® –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—ñ–≤:")
    for color, count in sorted(color_usage.items(), key=lambda x: x[1], reverse=True):
        percentage = (count / len(solution)) * 100
        print(f"   {color.value:15s}: {count:2d} –æ–±–ª–∞—Å—Ç–µ–π ({percentage:.1f}%)")
    
    print(f"\nüìä –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±–ª–∞—Å—Ç–µ–π: {len(solution)}")
    print(f"üé® –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∫–æ–ª—å–æ—Ä—ñ–≤: {len(color_usage)}")
    
    print("\n" + "=" * 70)

def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –ø—Ä–æ–≥—Ä–∞–º–∏"""
    print("=" * 70)
    print("üß© CSP - CONSTRAINT SATISFACTION PROBLEM")
    print("üìç –ó–∞–¥–∞—á–∞: –†–æ–∑—Ñ–∞—Ä–±—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏ –£–∫—Ä–∞—ó–Ω–∏")
    print("=" * 70)
    print("\nüìã –£–º–æ–≤–∞:")
    print("   ‚Ä¢ –ö–æ–∂–Ω—É –æ–±–ª–∞—Å—Ç—å —Ç—Ä–µ–±–∞ –ø–æ—Ñ–∞—Ä–±—É–≤–∞—Ç–∏ –≤ –æ–¥–∏–Ω –∫–æ–ª—ñ—Ä")
    print("   ‚Ä¢ –°—É—Å—ñ–¥–Ω—ñ –æ–±–ª–∞—Å—Ç—ñ –º–∞—é—Ç—å –±—É—Ç–∏ —Ä—ñ–∑–Ω–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤")
    print("   ‚Ä¢ –ú—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–ª—å–æ—Ä—ñ–≤")
    print()
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ CSP –∑–∞–¥–∞—á—É
    csp = create_ukraine_map()
    
    # –†–æ–∑–≤'—è–∑—É—î–º–æ
    solution = csp.solve()
    
    # –í–∏–≤–æ–¥–∏–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    print_solution(solution)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–æ–∑–≤'—è–∑–æ–∫
    if solution:
        csp.verify_solution(solution)
        print_statistics(solution)
    
    print("\n" + "=" * 70)
    print("‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("=" * 70)


if __name__ == "__main__":
    # –û—Å–Ω–æ–≤–Ω–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è
    main()
    
